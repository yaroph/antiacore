<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <!-- Square viewport: FiveM will use this as default size -->
  <meta content="width=910, height=910, initial-scale=1.0, user-scalable=no" name="viewport" />
  <title>Angry Flappy: Monsters & Quiz Battles</title>
  <link href="style.css" rel="stylesheet" />
  <link
    href="https://fonts.googleapis.com/css2?family=Press+Start+2P&amp;family=Silkscreen:wght@400;700&amp;display=swap"
    rel="stylesheet" />

  </head>

<body>
  <audio id="siteIntroAudio" src="assets/audio/intro_site.mp3" preload="auto" autoplay playsinline></audio>
  <div id="gameWrap">
    <div id="hudWrap">
      <div id="hud">
        <div style="display:flex;align-items:center;gap:8px">
          <div aria-label="lives" class="pixel-hud-left" id="lives"></div>
          <div id="hudPower" title="Power"><span>⚡</span> <b id="hudPowerVal">0</b></div>
        </div>
        <div aria-live="polite" class="pixel-hud-center" id="score" title="Distance">0</div>
        <div aria-label="capture balls" class="pixel-hud-right" id="balls" title="Capture balls">
          <svg aria-hidden="true" class="ballIcon" height="22" viewbox="0 0 64 64" width="22">
            <defs>
              <radialgradient cx="50%" cy="50%" id="gGlow" r="50%">
                <stop offset="0%" stop-color="#00fff0" stop-opacity="0.9"></stop>
                <stop offset="60%" stop-color="#00d4ff" stop-opacity="0.7"></stop>
                <stop offset="100%" stop-color="#00a3ff" stop-opacity="0.0"></stop>
              </radialgradient>
              <lineargradient id="gRing" x1="0%" x2="100%" y1="0%" y2="100%">
                <stop offset="0%" stop-color="#66fff9"></stop>
                <stop offset="50%" stop-color="#a067ff"></stop>
                <stop offset="100%" stop-color="#ff4dbe"></stop>
              </lineargradient>
            </defs>
            <circle cx="32" cy="32" fill="url(#gGlow)" r="22"></circle>
            <circle cx="32" cy="32" fill="none" r="15" stroke="url(#gRing)" stroke-width="6"></circle>
            <circle cx="32" cy="32" fill="#ffffff" r="3"></circle>
          </svg>
          <span id="ballsCount">0</span>
        </div>
      </div>
    </div>
    <canvas aria-label="Angry Flappy Game" height="910" id="game" width="910"></canvas>
    <div class="battle-bg" id="battleBg"></div>
    <div id="pokedexStart" style="display:none"></div>
    <div class="battle-overlay" id="battleOverlay">
      <div class="pixel-panel battle-toi hidden" id="battleToi"></div>
      <div class="batlle-top-menu">
        <div class="battle-top-player-menu">
          <div class="battle-top-text-container">
            <p class="player-name top-menu-p"> Joueur : </p>
            <p class="player-name top-menu-p" id="playerName"></p>
          </div>
          <div class="battle-top-text-container">
            <p class="player-power top-menu-p"> Puissance : </p>
            <p class="player-power top-menu-p" id="playerPower"></p>
          </div>
          <div class="battle-top-text-container">
            <p class="player-hp top-menu-p"> PV : </p>
            <p class="player-hp top-menu-p" id="playerHp"></p>
          </div>
          <div class="battle-top-text-container">
            <p class="player-name top-menu-p"> Boules : </p>
            <div class="player-name top-menu-p" id="playerBalls"></div>
          </div>
        </div>
        <div class="battle-top-player-menu">
          <div class="battle-top-text-container">
            <p class="monster-name top-menu-p"> Monstre : </p>
            <p class="monster-name top-menu-p" id="monsterName"></p>
          </div>
          <div class="battle-top-text-container">
            <p class="monster-power top-menu-p"> Puissance : </p>
            <p class="monster-power top-menu-p" id="monsterPower"></p>
          </div>
          <div class="battle-top-text-container">
            <p class="monster-hp top-menu-p"> PV : </p>
            <p class="monster-hp top-menu-p" id="monsterHp"></p>
          </div>
          <div class="battle-top-text-container">
            <p class="monster-capture top-menu-p"> Taux de capture : </p>
            <p class="monster-capture top-menu-p" id="captureRate"></p>
          </div>
        </div>
      </div>
      <div class="battle-dialog pixel-panel" id="dialogTurn">
        <div class="dialog-row">
          <div id="battleQuestionLabel"><strong id="questionText"></strong></div>
        </div>
        <div class="dialog-row">
          <div class="input-clear-wrapper">
            <input class="pixel-input" id="battleAnswer" name="answer" placeholder="Réponse ici" required=""
              type="text" />
            <button type="button" class="input-clear-btn" aria-label="Effacer">&times;</button>
          </div>
          <button class="pixel-btn success" id="answerBtn">Répondre</button>
          <button class="pixel-btn danger" id="fleeBtn" type="button">Fuir</button>
        </div>
        <div class="dialog-row">
          <button class="pixel-btn capture-button primary" id="captureBtn" type="button">Capturer (1 boule)</button>
          <span class="hint" id="captureHint"></span>
        </div>
      </div>
    </div>
    <div class="overlay show" id="splash"
      style="background:#0f380f;display:flex;align-items:center;justify-content:center;">
      <img alt="BNI" id="splashLogo" src="assets/logo_bni.png"
        style="width:min(320px,60vw);image-rendering:pixelated;transform:translateY(-120%);filter:drop-shadow(0 12px 0 rgba(0,0,0,.3))" />
      <audio id="bootSound" preload="auto"></audio>
    </div>
    <div class="overlay synth-bg" id="startScreen">
      <div class="panel gb-panel">
        <div style="display:flex;justify-content:center;margin:10px 0 16px"><img alt="Title" class="logo-title"
            src="assets/antiacor_gameboy.png" /></div>
        <div class="press-start blink">PRESS START</div>
        <div class="row center">
          <button class="btn gb-btn" id="startBtn">START</button>
          <button class="btn gb-btn" id="highscoreBtn" style="margin-top:8px">HIGHSCORE</button>
        </div>
        <div class="row center" style="margin-top:8px">
          <button class="btn gb-btn" id="startMusicToggleBtn">Désactiver la musique</button>
          <button class="btn gb-btn danger" id="startLogoutBtn" style="display:none;">Déconnexion</button>
        </div>
      </div>
    </div>
    <div class="overlay synth-bg" id="corruptOverlay">
      <div class="panel pixel-panel gb-panel">
        <h2 class="gb-h2" id="corruptTitle">Monstre Corrompu</h2>
        <div class="corrupt-visual" id="corruptVisual" style="display:flex;justify-content:center;margin:8px 0 12px">
        </div>
        <div class="row center">
          <button class="btn gb-btn monster-delete" id="trashBtn">SUPPRIMER</button>
          <button class="btn gb-btn monster-save" id="saveBtn">UTILISER 0 BOULES</button>
        </div>
      </div>
    </div>
    <div class="overlay synth-bg" id="gameOver">
      <div class="panel pixel-panel gb-panel">
        <h2 class="gb-h2">GAME OVER</h2>
<div class="score-grid">
          <div class="score-col">
            <div class="score-title">— DERNIÈRE PARTIE —</div>
            <div class="score-row"><span>Distance :</span> <b id="prevDistance">0 m</b></div>
            <div class="score-row"><span>Captures :</span> <b id="prevCaptures">0</b></div>
            <div class="score-row"><span>Score :</span> <b id="prevScore">0</b></div>
          </div>
          <div class="score-col">
            <div class="score-title">— MEILLEUR SCORE —</div>
            <div class="score-row"><span>Distance :</span> <b id="bestDistance">0 m</b></div>
            <div class="score-row"><span>Captures :</span> <b id="bestCaptures">0</b></div>
            <div class="score-row"><span>Score :</span> <b id="bestScoreVal">0</b></div>
          </div>
        </div>
        <div class="row" id="sortControls" style="margin:10px 0;">
          <select class="sortSel" id="sortBy">
            <option value="alpha">Tri : Alphabétique</option>
            <option value="level">Tri : Niveau global</option>
            <option value="power">Tri : Puissance</option>
            <option value="hp">Tri : PV</option>
          </select>
          <select class="sortSel" id="sortDir">
            <option value="asc">Ordre : Croissant</option>
            <option value="desc">Ordre : Décroissant</option>
          </select>
        </div>
        <h3 class="gb-h3">Collection Capturée</h3>
        <div class="dex" id="pokedex"></div>
        <div class="row center">
          <button class="btn gb-btn" id="retryBtn">REJOUER SANS MONSTRE</button>
          <button class="btn gb-btn ghost" id="sendBtnOver">ENVOYER UN MONSTRE</button>
          <button class="btn gb-btn" id="highscoreBtnOver">HIGHSCORE</button>
          <button class="btn gb-btn" id="gameOverMusicToggleBtn">Désactiver la musique</button>
        </div>
      </div>
    </div>
    <div class="personal-answers-container" id="personalAnswersContainer">
      <div class="panel pixel-panel gb-panel">
        <h2 class="gb-h2">Réponses aux Questions Personnelles</h2>
        <div class="answer-title-container">
          <p class="answer-title"> Questions </p>
          <p class="answer-title"> Réponses </p>
        </div>
        <div class="answers-list-container" id="answersList">
           <div class="questions-container" id="questionsContainer"></div>
           <div class="answers-container" id="answersContainer"></div>
        </div>
        <div class="row center" style="margin-top:10px">
          <button class="btn gb-btn " id="closePersonalBtn">FERMER</button>
        </div>
      </div>
    </div>

    <script src="saves/saveAdapter.js"></script>
    <script src="auth/login.js"></script>
    <script src="saves/highscore.js"></script>
    <script> window.addEventListener("load", () => { if (window.AF_showLogin) AF_showLogin(); });</script>
    <script src="questions.general.js"></script>
    <script src="questions.personal.js"></script>
    <script src="questions.merge.js"></script>
    <script src="monsters.js"></script>
    <script src="audio.js"></script>
  <script src="game.js"></script>
  </div>

    <script src="opacity-start-toggle.js"></script>

  

  </div>


  
<script>
(function(){
  function startMusic(){
    try {
      if (window.music && typeof window.music.menuIntroThenLoop === "function") {
        window.music.menuIntroThenLoop();
      } else if (window.music && typeof window.music.startLoop === "function") {
        window.music.startLoop();
      }
    } catch(e){}
  }

  function unlock(){
    try {
      var AC = window.AudioContext || window.webkitAudioContext;
      if (AC && window._af_ctx instanceof AC) {
        window._af_ctx.resume().catch(function(){});
      }
    } catch(e){}
    startMusic();
    document.removeEventListener("pointerdown", unlock);
    document.removeEventListener("keydown", unlock);
    document.removeEventListener("touchstart", unlock);
  }

  document.addEventListener("DOMContentLoaded", function(){
    // Try autoplay immediately; if blocked, the first click/keypress will start it
    startMusic();
  });
  document.addEventListener("pointerdown", unlock, {passive:true});
  document.addEventListener("touchstart", unlock, {passive:true});
  document.addEventListener("keydown", unlock);
})();
</script>

<script src="assets/single-audio-guard.js"></script>

<script>
(function(){
  function isMuted(){ try { return localStorage.getItem('AF_musicMuted') === '1'; } catch(e){ return false; } }
  function setMuted(m){
    try { localStorage.setItem('AF_musicMuted', m ? '1' : '0'); } catch(e){}
    if (window.music){
      window.music.volume = m ? 0 : (window.music.volume && window.music.volume > 0 ? window.music.volume : 0.8);
      if (window.music.current){ try { window.music.current.volume = window.music.volume; } catch(e){} }
    } else if (window.audio && window.audio.music){
      window.audio.music.volume = m ? 0 : (window.audio.music.volume && window.audio.music.volume > 0 ? window.audio.music.volume : 0.8);
      if (window.audio.music.current){ try { window.audio.music.current.volume = window.audio.music.volume; } catch(e){} }
    }
    updateLabels();
  }
  function isMusicOn(){
    var vol = 0;
    if (window.music) vol = window.music.volume || 0;
    else if (window.audio && window.audio.music) vol = window.audio.music.volume || 0;
    return vol > 0;
  }
  function updateLabels(){
    var startBtn = document.getElementById('startMusicToggleBtn');
    var overBtn  = document.getElementById('gameOverMusicToggleBtn');
    var on = isMusicOn();
    if (startBtn) startBtn.textContent = on ? 'Désactiver la musique' : 'Activer la musique';
    if (overBtn)  overBtn.textContent  = on ? 'Désactiver la musique' : 'Activer la musique';
  }
  function toggle(){
    var on = isMusicOn();
    setMuted(on); // if currently on, mute; if off, unmute
  }
  document.addEventListener('click', function(ev){
    var id = ev.target && ev.target.id;
    if (id === 'startMusicToggleBtn' || id === 'gameOverMusicToggleBtn'){
      ev.preventDefault(); ev.stopPropagation();
      toggle();
    }
  }, true);
  // initialize from storage on DOMContentLoaded
  document.addEventListener('DOMContentLoaded', function(){
    var muted = isMuted();
    if (muted) setMuted(true); else setMuted(false);
    updateLabels();
  });
})();
</script>

<script>
// Logout button handler for PRESS START screen
(function(){
  var SESSION_KEY = 'af_session';

  function isLoggedIn(){
    try {
      var data = localStorage.getItem(SESSION_KEY);
      return !!data;
    } catch(e){}
    return false;
  }

  function updateLogoutBtnVisibility(){
    var logoutBtn = document.getElementById('startLogoutBtn');
    if (logoutBtn){
      logoutBtn.style.display = isLoggedIn() ? 'inline-flex' : 'none';
    }
  }

  document.addEventListener('DOMContentLoaded', updateLogoutBtnVisibility);
  window.addEventListener('af:login:done', updateLogoutBtnVisibility);

  document.addEventListener('click', function(ev){
    if (ev.target && ev.target.id === 'startLogoutBtn'){
      ev.preventDefault();
      ev.stopPropagation();
      if (window.AF_logout){
        window.AF_logout();
      } else {
        try { localStorage.removeItem(SESSION_KEY); } catch(e){}
        window.location.reload();
      }
    }
  }, true);
})();
</script>

<script>
// Input clear button functionality
(function(){
  function updateClearBtnVisibility(wrapper){
    var input = wrapper.querySelector('input');
    if (input && input.value.length > 0){
      wrapper.classList.add('has-text');
    } else {
      wrapper.classList.remove('has-text');
    }
  }

  function setupClearButtons(){
    var wrappers = document.querySelectorAll('.input-clear-wrapper');
    wrappers.forEach(function(wrapper){
      var input = wrapper.querySelector('input');
      var clearBtn = wrapper.querySelector('.input-clear-btn');
      if (!input || !clearBtn) return;

      // Update visibility on input
      input.addEventListener('input', function(){
        updateClearBtnVisibility(wrapper);
      });

      // Initial check
      updateClearBtnVisibility(wrapper);

      // Clear button click handler
      clearBtn.addEventListener('click', function(e){
        e.preventDefault();
        e.stopPropagation();
        input.value = '';
        input.focus();
        updateClearBtnVisibility(wrapper);
        // Trigger input event for any listeners
        input.dispatchEvent(new Event('input', { bubbles: true }));
      });
    });
  }

  // Setup on DOMContentLoaded
  document.addEventListener('DOMContentLoaded', setupClearButtons);

  // Also re-check periodically for dynamically added inputs
  var observer = new MutationObserver(function(mutations){
    mutations.forEach(function(mutation){
      if (mutation.addedNodes.length > 0){
        setupClearButtons();
      }
    });
  });
  document.addEventListener('DOMContentLoaded', function(){
    observer.observe(document.body, { childList: true, subtree: true });
  });
})();
</script>

</body>

</html>
